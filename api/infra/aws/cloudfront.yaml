AWSTemplateFormatVersion: "2010-09-09"
Description: CF template to create CloudFront distribution to serve websites hosted in S3.
Resources:

  LandingPageWebAppCloudFrontOriginAccessControl:
    Type: AWS::CloudFront::OriginAccessControl
    Properties:
      OriginAccessControlConfig:
        Description: Landing Page Origin Access Control
        Name: LandingPageWebOAC
        OriginAccessControlOriginType: s3
        SigningBehavior: always
        SigningProtocol: sigv4

  LandingPageWebAppCloudFrontDistribution:
    Type: AWS::CloudFront::Distribution
    Properties:
      DistributionConfig:
        Aliases:
          - www.torvek.com
        Comment: Distribution for landing page web app.
        CustomErrorResponses:
          - ErrorCachingMinTTL: 300
            ErrorCode: 403
            ResponseCode: 200
            ResponsePagePath: /index.html
        DefaultCacheBehavior:
          AllowedMethods:
            - GET
            - HEAD
            - OPTIONS
          ForwardedValues:
            QueryString: false
          TargetOriginId: LandingPageWebAppOrigin
          ViewerProtocolPolicy: redirect-to-https
        DefaultRootObject: index.html
        Enabled: true
        Origins:
          - DomainName: !ImportValue LandingPageWebAppBucketDomainName
            Id: LandingPageWebAppOrigin
            S3OriginConfig:
              OriginAccessIdentity: ""
            OriginAccessControlId: !GetAtt LandingPageWebAppCloudFrontOriginAccessControl.Id
        ViewerCertificate:
          AcmCertificateArn: !ImportValue LandingPageWebCertificateArn
          SslSupportMethod: sni-only

  CustomerWebAppCloudFrontOriginAccessControl:
    Type: AWS::CloudFront::OriginAccessControl
    Properties:
      OriginAccessControlConfig:
        Description: Customer Web App Origin Access Control
        Name: CustomerWebAppOAC
        OriginAccessControlOriginType: s3
        SigningBehavior: always
        SigningProtocol: sigv4

  CustomerWebAppCloudFrontDistribution:
    Type: AWS::CloudFront::Distribution
    Properties:
      DistributionConfig:
        Aliases:
          - app.torvek.com
        Comment: Distribution for customer web app.
        CustomErrorResponses:
          - ErrorCachingMinTTL: 300
            ErrorCode: 403
            ResponseCode: 200
            ResponsePagePath: /index.html
        DefaultCacheBehavior:
          AllowedMethods:
            - GET
            - HEAD
            - OPTIONS
          ForwardedValues:
            QueryString: false
          TargetOriginId: CustomerWebAppOrigin
          ViewerProtocolPolicy: redirect-to-https
        DefaultRootObject: index.html
        Enabled: true
        Origins:
          - DomainName: !ImportValue CustomerWebAppBucketDomainName
            Id: CustomerWebAppOrigin
            S3OriginConfig:
              OriginAccessIdentity: ""
            OriginAccessControlId: !GetAtt CustomerWebAppCloudFrontOriginAccessControl.Id
        ViewerCertificate:
          AcmCertificateArn: !ImportValue CustomerWebAppCertificateArn
          SslSupportMethod: sni-only

  AdminWebAppCloudFrontOriginAccessControl:
    Type: AWS::CloudFront::OriginAccessControl
    Properties:
      OriginAccessControlConfig:
        Description: Admin Web App Origin Access Control
        Name: AdminPortalOAC
        OriginAccessControlOriginType: s3
        SigningBehavior: always
        SigningProtocol: sigv4

  AdminWebAppCloudFrontDistribution:
    Type: AWS::CloudFront::Distribution
    Properties:
      DistributionConfig:
        Aliases:
          - admin.torvek.com
        Comment: Distribution for admin web app.
        CustomErrorResponses:
          - ErrorCachingMinTTL: 300
            ErrorCode: 403
            ResponseCode: 200
            ResponsePagePath: /index.html
        DefaultCacheBehavior:
          AllowedMethods:
            - GET
            - HEAD
            - OPTIONS
          ForwardedValues:
            QueryString: false
          TargetOriginId: AdminWebAppOrigin
          ViewerProtocolPolicy: redirect-to-https
        DefaultRootObject: index.html
        Enabled: true
        Origins:
          - DomainName: !ImportValue AdminWebAppBucketDomainName
            Id: AdminWebAppOrigin
            S3OriginConfig:
              OriginAccessIdentity: ""
            OriginAccessControlId: !GetAtt AdminWebAppCloudFrontOriginAccessControl.Id
        ViewerCertificate:
          AcmCertificateArn: !ImportValue AdminPortalCertificateArn
          SslSupportMethod: sni-only

  SupplierWebAppCloudFrontOriginAccessControl:
    Type: AWS::CloudFront::OriginAccessControl
    Properties:
      OriginAccessControlConfig:
        Description: Supplier Web App Origin Access Control
        Name: SupplierPortalOAC
        OriginAccessControlOriginType: s3
        SigningBehavior: always
        SigningProtocol: sigv4

  SupplierWebAppCloudFrontDistribution:
    Type: AWS::CloudFront::Distribution
    Properties:
      DistributionConfig:
        Aliases:
          - suppliers.torvek.com
        Comment: Distribution for supplier web app  .
        CustomErrorResponses:
          - ErrorCachingMinTTL: 300
            ErrorCode: 403
            ResponseCode: 200
            ResponsePagePath: /index.html
        DefaultCacheBehavior:
          AllowedMethods:
            - GET
            - HEAD
            - OPTIONS
          ForwardedValues:
            QueryString: false
          TargetOriginId: SupplierWebAppOrigin
          ViewerProtocolPolicy: redirect-to-https
        DefaultRootObject: index.html
        Enabled: true
        Origins:
          - DomainName: !ImportValue SupplierWebAppBucketDomainName
            Id: SupplierWebAppOrigin
            S3OriginConfig:
              OriginAccessIdentity: ""
            OriginAccessControlId: !GetAtt SupplierWebAppCloudFrontOriginAccessControl.Id
        ViewerCertificate:
          AcmCertificateArn: !ImportValue SupplierPortalCertificateArn
          SslSupportMethod: sni-only

Outputs:
  LandingPageWebAppCloudFrontDistributionId:
    Description: Id for the landing page web CloudFront distribution
    Value: !Ref LandingPageWebAppCloudFrontDistribution
    Export:
      Name: LandingPageWebAppCloudFrontDistributionId
  CustomerWebAppCloudFrontDistributionId:
    Description: Id for the customer web app CloudFront distribution
    Value: !Ref CustomerWebAppCloudFrontDistribution
    Export:
      Name: CustomerWebAppCloudFrontDistributionId
  AdminWebAppCloudFrontDistributionId:
    Description: Id for the admin web app CloudFront distribution
    Value: !Ref AdminWebAppCloudFrontDistribution
    Export:
      Name: AdminWebAppCloudFrontDistributionId
  SupplierWebAppCloudFrontDistributionId:
    Description: Id for the supplier web app CloudFront distribution
    Value: !Ref SupplierWebAppCloudFrontDistribution
    Export:
      Name: SupplierWebAppCloudFrontDistributionId
